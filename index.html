<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ökosystem See – Trophieebenen (Zuordnung)</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#aab6d6;
      --accent:#63b3ff;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --border:rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 0%, rgba(99,179,255,.18), transparent 60%),
        radial-gradient(800px 500px at 80% 20%, rgba(52,211,153,.12), transparent 55%),
        linear-gradient(180deg, #060b16 0%, var(--bg) 40%, #060b16 100%);
      min-height:100vh;
    }

    header{
      padding:22px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }

    h1{
      margin:0 0 6px;
      font-size:22px;
      letter-spacing:.2px;
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:15px;
      line-height:1.55;
    }

    .subtitle.task{
      font-size:16px;
      color:#dbe7ff;
    }

    .taskSmall{
      display:block;
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 28px;
      display:grid;
      grid-template-columns: 1.05fr 1.95fr;
      gap:14px;
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr;}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panelHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .panelHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.25px;
      color:#dbe7ff;
    }

    .panelHeader .hint{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      margin-top:2px;
    }

    .topControls .pill{
      padding:6px 10px;
      font-size:12px;
      white-space:nowrap;
    }

    .infoBtn{
      margin-left:6px;
      width:20px;
      height:20px;
      border-radius:999px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      line-height:1;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:rgba(231,238,252,.9);
      cursor:pointer;
      transform:translateY(-1px);
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action: manipulation;
    }

    .infoBtn:hover{background:rgba(255,255,255,.10)}
    .infoBtn:active{transform:translateY(0)}

    button{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action: pan-y;
    }

    button:hover{background:rgba(255,255,255,.09)}
    button:active{transform:translateY(1px)}

    button.primary{
      background:rgba(99,179,255,.18);
      border-color:rgba(99,179,255,.35);
    }
    button.primary:hover{background:rgba(99,179,255,.24)}

    button.bad{
      background:rgba(251,113,133,.14);
      border-color:rgba(251,113,133,.32);
    }

    .content{ padding:14px; }

    /* cards */
    .pool{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-content:flex-start;
      min-height:120px;
    }

    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 10px;
      min-width:140px;
      max-width:220px;
      cursor:grab;
      user-select:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      position:relative;
    }

    .card:hover{transform:translateY(-1px); border-color:rgba(99,179,255,.35)}
    .card:active{cursor:grabbing; transform:translateY(0)}

    .card .name{font-size:13px; font-weight:650; letter-spacing:.15px; padding-right:64px; line-height:1.25;}
    .card .mini{font-size:11px; color:var(--muted); margin-top:2px;}

    .card.correct{border-color: rgba(52,211,153,.55); background:rgba(52,211,153,.10)}
    .card.wrong{border-color: rgba(251,113,133,.55); background:rgba(251,113,133,.10)}

    .card.tapSelected{
      border-color: rgba(99,179,255,.72);
      background: rgba(99,179,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
    }

    /* drop zones */
    .zones{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    @media (max-width: 980px){
      .zones{grid-template-columns:1fr;}
    }

    .zone{
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      min-height:160px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .zone.dragOver{
      border-color:rgba(99,179,255,.55);
      background:rgba(99,179,255,.10);
    }

    .zoneHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }

    .zoneTitle{
      font-size:13px;
      font-weight:750;
      letter-spacing:.2px;
    }

    .zoneSub{
      font-size:11px;
      color:var(--muted);
    }

    .zoneBody{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-content:flex-start;
      min-height:90px;
    }

    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }

    .pill.good{color:#b9ffe4; border-color:rgba(52,211,153,.35); background:rgba(52,211,153,.10)}
    .pill.bad{color:#ffd1d9; border-color:rgba(251,113,133,.35); background:rgba(251,113,133,.10)}
    .pill.warn{color:#ffe8b5; border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.10)}

    .footerNote{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 26px;
      color:rgba(255,255,255,.5);
      font-size:11px;
      line-height:1.5;
    }

    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.7);
    }

    /* Hover-Bildvorschau (Mouse) */
    .hoverTip{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:min(340px, 78vw);
      z-index:10050;
      opacity:0;
      transform:translate3d(0,0,0);
      transition:opacity .08s ease;
      pointer-events:none;
    }
    .hoverTip.show{opacity:1;}
    .hoverTip .htBox{
      background:rgba(6,11,22,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      box-shadow: 0 16px 40px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .hoverTip img{width:100%; height:auto; display:block; background:rgba(255,255,255,.04);}
    .hoverTip .htBody{padding:10px 12px;}
    .hoverTip .htTitle{font-size:12px; font-weight:750; letter-spacing:.15px; margin:0 0 4px;}
    .hoverTip .htMeta{font-size:11px; color:rgba(255,255,255,.65); line-height:1.35;}
    .hoverTip .htMeta a{color:rgba(99,179,255,.92); text-decoration:none;}
    .hoverTip .htMeta a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <header>
    <h1>Ökosystem See: Trophieebenen zuordnen</h1>
    <p class="subtitle task">
      Ordne die Organismen den Trophieebenen zu (Produzenten, Konsumenten 1.–3. Ordnung) und klicke anschließend auf <b>Prüfen</b>.
      <span class="taskSmall">Tablet: Karte antippen und danach das Ziel-Feld antippen.</span>
    </p>
  </header>

  <main class="wrap">
    <!-- LEFT: Pool -->
    <section class="panel" aria-label="Kartenpool">
      <div class="panelHeader">
        <div>
          <h2>Karten</h2>
          <p class="hint">PC: Ziehen und ablegen. Tablet: Karte antippen, dann Feld antippen.</p>
        </div>
        <div class="controls topControls">
          <div id="scorePill" class="pill">Punkte: –</div>
          <div id="cardsPill" class="pill">Karten: –</div>
          <button id="btnCheck" class="primary" title="Überprüft Zuordnung">Prüfen</button>
          <button id="btnReset" class="bad" title="Alles zurück in den Pool">Zurücksetzen</button>
        </div>
      </div>
      <div class="content">
        <div id="pool" class="pool" role="list" aria-label="Kartenpool"></div>
      </div>
    </section>

    <!-- RIGHT: Zones -->
    <section class="panel" aria-label="Zuordnung">
      <div class="panelHeader">
        <div>
          <h2>Zuordnung: Trophieebenen</h2>
          <p class="hint">Tippe auf das Info-Symbol (i), um eine kurze Definition zu sehen.</p>
        </div>
      </div>

      <div class="content">
        <div class="zones" aria-label="Drop-Zonen">
          <div class="zone" data-zone="producer" aria-label="Produzenten" tabindex="0">
            <div class="zoneHead">
              <div>
                <div class="zoneTitle">Produzenten <button type="button" class="infoBtn" data-help="producer" aria-label="Hilfe: Produzenten">i</button></div>
                <div class="zoneSub">Autotroph: Pflanzen, Algen</div>
              </div>
              <div class="pill" id="count-producer">0</div>
            </div>
            <div class="zoneBody" id="zone-producer"></div>
          </div>

          <div class="zone" data-zone="c1" aria-label="Konsumenten 1. Ordnung" tabindex="0">
            <div class="zoneHead">
              <div>
                <div class="zoneTitle">Konsumenten 1. Ordnung <button type="button" class="infoBtn" data-help="c1" aria-label="Hilfe: Konsumenten 1. Ordnung">i</button></div>
                <div class="zoneSub">Herbivor/Detritivor: fressen Produzenten</div>
              </div>
              <div class="pill" id="count-c1">0</div>
            </div>
            <div class="zoneBody" id="zone-c1"></div>
          </div>

          <div class="zone" data-zone="c2" aria-label="Konsumenten 2. Ordnung" tabindex="0">
            <div class="zoneHead">
              <div>
                <div class="zoneTitle">Konsumenten 2. Ordnung <button type="button" class="infoBtn" data-help="c2" aria-label="Hilfe: Konsumenten 2. Ordnung">i</button></div>
                <div class="zoneSub">Karnivor/Omnivor: fressen K1</div>
              </div>
              <div class="pill" id="count-c2">0</div>
            </div>
            <div class="zoneBody" id="zone-c2"></div>
          </div>

          <div class="zone" data-zone="c3" aria-label="Konsumenten 3. Ordnung" tabindex="0">
            <div class="zoneHead">
              <div>
                <div class="zoneTitle">Konsumenten 3. Ordnung <button type="button" class="infoBtn" data-help="c3" aria-label="Hilfe: Konsumenten 3. Ordnung">i</button></div>
                <div class="zoneSub">Top-Prädatoren: fressen K2</div>
              </div>
              <div class="pill" id="count-c3">0</div>
            </div>
            <div class="zoneBody" id="zone-c3"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="footerNote">
    <b>Hinweis:</b> Je nach Art/Alter/Größe können Einordnungen variieren.
    Das hier ist eine bewusst vereinfachte, schulgeeignete Version.
    Organismen kannst du im JS-Array <span class="kbd">ORGANISMS</span> anpassen.
    <br />
    <b>Bilder:</b> Beim Überfahren einer Karte mit der Maus wird eine Bildvorschau angezeigt. Die verwendeten Bilder stammen von Wikimedia Commons (freie Lizenzen; Details über den Quellen-Link in der Vorschau).
  </div>

  <!-- Hover-Vorschau (wird per JS befüllt) -->
  <div id="hoverTip" class="hoverTip" aria-hidden="true">
    <div class="htBox" role="dialog" aria-label="Bildvorschau">
      <img id="hoverImg" alt="" loading="lazy" />
      <div class="htBody">
        <p class="htTitle" id="hoverTitle"></p>
        <div class="htMeta">
          Quelle: <a id="hoverSource" href="#" target="_blank" rel="noopener noreferrer">Wikimedia Commons</a>
          <span> (Lizenz siehe Quelle)</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======= Daten =======
    const ORGANISMS = [
      // Produzenten
      { id: "phyto", name: "Phytoplankton (Algen)", correct: "producer" },
      { id: "waterpest", name: "Wasserpest (Elodea)", correct: "producer" },
      { id: "seerose", name: "Seerose", correct: "producer" },
      { id: "schilf", name: "Schilf", correct: "producer" },

      // Konsumenten 1. Ordnung
      { id: "daphnia", name: "Wasserfloh (Daphnia)", correct: "c1" },
      { id: "zoopl", name: "Zooplankton (z.B. Rädertierchen)", correct: "c1" },
      { id: "snail", name: "Posthornschnecke", correct: "c1" },
      { id: "mussel", name: "Muschel (z.B. Teichmuschel)", correct: "c1" },
      { id: "tadpole", name: "Kaulquappe (viele Arten)", correct: "c1" },
      { id: "midge", name: "Zuckmückenlarve", correct: "c1" },

      // Konsumenten 2. Ordnung
      { id: "stickle", name: "Stichling", correct: "c2" },
      { id: "roach", name: "Rotauge (kleiner Fisch)", correct: "c2" },
      { id: "dragon", name: "Libellenlarve", correct: "c2" },
      { id: "dytiscus", name: "Gelbrandkäfer (Larve/Imago)", correct: "c2" },

      // Konsumenten 3. Ordnung
      { id: "pike", name: "Hecht", correct: "c3" },
      { id: "corm", name: "Kormoran", correct: "c3" },
      { id: "heron", name: "Graureiher", correct: "c3" },
      { id: "otter", name: "Fischotter", correct: "c3" },
    ];

    // ======= Bildquellen (Wikimedia Commons; Lizenzdetails auf der Dateiseite) =======
    const IMAGE_MAP = {
      phyto:    { file: "Phytoplankton.jpg", page: "https://commons.wikimedia.org/wiki/File:Phytoplankton.jpg" },
      waterpest:{ file: "Elodea_canadensis.jpg", page: "https://commons.wikimedia.org/wiki/File:Elodea_canadensis.jpg" },
      seerose:  { file: "Nymphaea_alba-Flower.jpg", page: "https://commons.wikimedia.org/wiki/File:Nymphaea_alba-Flower.jpg" },
      schilf:   { file: "Phragmites_Australis_(240719361).jpeg", page: "https://commons.wikimedia.org/wiki/File:Phragmites_Australis_(240719361).jpeg" },
      daphnia:  { file: "Daphnia_magna_-_NTNU.jpg", page: "https://commons.wikimedia.org/wiki/File:Daphnia_magna_-_NTNU.jpg" },
      zoopl:    { file: "Brachionuscalyciflorus.jpg", page: "https://commons.wikimedia.org/wiki/File:Brachionuscalyciflorus.jpg" },
      snail:    { file: "Planorbarius_corneus_001.JPG", page: "https://commons.wikimedia.org/wiki/File:Planorbarius_corneus_001.JPG" },
      mussel:   { file: "Anodonta_anatina_01.jpg", page: "https://commons.wikimedia.org/wiki/File:Anodonta_anatina_01.jpg" },
      tadpole:  { file: "Kaulquappen_Tadpole_1.JPG", page: "https://commons.wikimedia.org/wiki/File:Kaulquappen_Tadpole_1.JPG" },
      midge:    { file: "Mikrofoto.de-Zuckmueckenlarve3.jpg", page: "https://commons.wikimedia.org/wiki/File:Mikrofoto.de-Zuckmueckenlarve3.jpg" },
      stickle:  { file: "Gasterosteus_aculeatus_-_50737277588.jpg", page: "https://commons.wikimedia.org/wiki/File:Gasterosteus_aculeatus_-_50737277588.jpg" },
      roach:    { file: "RutilusRutilus.JPG", page: "https://commons.wikimedia.org/wiki/File:RutilusRutilus.JPG" },
      dragon:   { file: "Libellenlarven.jpg", page: "https://commons.wikimedia.org/wiki/File:Libellenlarven.jpg" },
      dytiscus: { file: "Dytiscus_marginalis.jpg", page: "https://commons.wikimedia.org/wiki/File:Dytiscus_marginalis.jpg" },
      pike:     { file: "Esox_Lucius.JPG", page: "https://commons.wikimedia.org/wiki/File:Esox_Lucius.JPG" },
      corm:     { file: "Phalacrocorax_carbo_Vic.jpg", page: "https://commons.wikimedia.org/wiki/File:Phalacrocorax_carbo_Vic.jpg" },
      heron:    { file: "Ardea_Cinerea.jpg", page: "https://commons.wikimedia.org/wiki/File:Ardea_Cinerea.jpg" },
      otter:    { file: "Lutra_lutra_qtl3.jpg", page: "https://commons.wikimedia.org/wiki/File:Lutra_lutra_qtl3.jpg" },
    };

    function commonsFileUrl(fileName, width=520){
      return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}?width=${width}`;
    }

    function getImageInfo(cardId){
      return IMAGE_MAP[cardId] || null;
    }

    // ======= Tablet-Modus (Tap-to-Move) =======
    // iPadOS/Safari: HTML5 Drag&Drop ist unzuverlässig. Daher: Karte antippen -> Feld antippen.
    const TAP_MODE = !!(window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);

    // ======= State =======
    const state = {
      marksOn: false,
      placement: new Map(),
      selectedCardId: null, // nur im Tablet-Modus
    };

    // ======= DOM =======
    const poolEl = document.getElementById("pool");
    const scorePill = document.getElementById("scorePill");
    const cardsPill = document.getElementById("cardsPill");

    const zoneBodies = {
      producer: document.getElementById("zone-producer"),
      c1: document.getElementById("zone-c1"),
      c2: document.getElementById("zone-c2"),
      c3: document.getElementById("zone-c3"),
      pool: poolEl,
    };

    const zoneCountEls = {
      producer: document.getElementById("count-producer"),
      c1: document.getElementById("count-c1"),
      c2: document.getElementById("count-c2"),
      c3: document.getElementById("count-c3"),
    };

    const btnReset = document.getElementById("btnReset");
    const btnCheck = document.getElementById("btnCheck");

    // Hover-Vorschau DOM
    const hoverTipEl = document.getElementById('hoverTip');
    const hoverImgEl = document.getElementById('hoverImg');
    const hoverTitleEl = document.getElementById('hoverTitle');
    const hoverSourceEl = document.getElementById('hoverSource');

    // ======= Helpers =======
    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function setStatus(text, kind=""){
      scorePill.textContent = text;
      scorePill.className = "pill" + (kind ? " " + kind : "");
    }

    function updateCounts(){
      const counts = { producer:0, c1:0, c2:0, c3:0, pool:0 };
      for(const o of ORGANISMS){
        const z = state.placement.get(o.id) || "pool";
        counts[z]++;
      }
      zoneCountEls.producer.textContent = counts.producer;
      zoneCountEls.c1.textContent = counts.c1;
      zoneCountEls.c2.textContent = counts.c2;
      zoneCountEls.c3.textContent = counts.c3;
      cardsPill.textContent = `Karten: ${ORGANISMS.length} (im Pool: ${counts.pool})`;
    }

    function updateScore(){
      let placed = 0;
      let correct = 0;

      for(const org of ORGANISMS){
        const z = state.placement.get(org.id) || 'pool';
        if(z !== 'pool'){
          placed++;
          if(z === org.correct) correct++;
        }
      }

      const pct = placed ? Math.round((correct / placed) * 100) : 0;
      let kind = 'warn';
      if(placed === 0) kind = '';
      else if(pct >= 85) kind = 'good';
      else if(pct < 60) kind = 'bad';

      setStatus(`Punkte: ${correct}/${placed} korrekt (${pct}%)`, kind);
    }

    function clearMarks(){
      state.marksOn = false;
      document.querySelectorAll('.card').forEach(c => c.classList.remove('correct','wrong'));
      setStatus('Punkte: –');
    }

    function selectCard(cardId){
      if(!TAP_MODE) return;
      state.selectedCardId = (state.selectedCardId === cardId) ? null : cardId;
      renderAll();
    }

    // ======= Hover-Bildvorschau (Mouse) =======
    function positionHover(x, y){
      const pad = 14;
      const rect = hoverTipEl.getBoundingClientRect();
      const w = rect.width || 320;
      const h = rect.height || 240;
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      let left = x + pad;
      let top = y + pad;
      if(left + w + pad > vw) left = x - w - pad;
      if(top + h + pad > vh) top = y - h - pad;

      left = Math.max(pad, Math.min(vw - w - pad, left));
      top = Math.max(pad, Math.min(vh - h - pad, top));

      hoverTipEl.style.left = left + 'px';
      hoverTipEl.style.top = top + 'px';
    }

    function showHover(cardId, x, y){
      const info = getImageInfo(cardId);
      if(!info) return;
      const org = ORGANISMS.find(o => o.id === cardId);

      hoverTitleEl.textContent = org ? org.name : '';
      hoverImgEl.alt = org ? org.name : 'Bild';
      hoverSourceEl.href = info.page;

      hoverImgEl.onerror = () => {
        hoverImgEl.onerror = null;
        hoverImgEl.src = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg';
      };
      hoverImgEl.src = commonsFileUrl(info.file, 520);

      hoverTipEl.classList.add('show');
      hoverTipEl.setAttribute('aria-hidden','false');
      positionHover(x, y);
    }

    function hideHover(){
      hoverTipEl.classList.remove('show');
      hoverTipEl.setAttribute('aria-hidden','true');
      hoverTipEl.style.left = '-9999px';
      hoverTipEl.style.top = '-9999px';
    }

    // ======= Rendering =======
    function createCardEl(org){
      const el = document.createElement('div');
      el.className = 'card';
      el.id = `card-${org.id}`;
      el.setAttribute('role','listitem');
      el.dataset.cardId = org.id;

      // Desktop: Drag & Drop aktivieren
      el.draggable = !TAP_MODE;

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = org.name;

      const mini = document.createElement('div');
      mini.className = 'mini';
      mini.textContent = TAP_MODE ? 'Antippen zum Auswählen' : 'Ziehen und ablegen';

      el.appendChild(name);
      el.appendChild(mini);

      if(state.selectedCardId === org.id) el.classList.add('tapSelected');

      // Desktop Dragstart
      el.addEventListener('dragstart', (e) => {
        if(!e.dataTransfer) return;
        e.dataTransfer.setData('text/plain', org.id);
        e.dataTransfer.effectAllowed = 'move';
      });

      // Tablet: Antippen = auswählen
      el.addEventListener('pointerdown', (e) => {
        if(!TAP_MODE) return;
        if(e.pointerType !== 'touch' && e.pointerType !== 'pen') return;
        e.preventDefault();
        e.stopPropagation();
        selectCard(org.id);
      }, { passive: false });

      // Tastatur: Enter/Space = in die nächste Zone schieben
      el.tabIndex = 0;
      el.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          const order = ['pool','producer','c1','c2','c3'];
          const current = state.placement.get(org.id) || 'pool';
          const next = order[(order.indexOf(current)+1) % order.length];
          moveCard(org.id, next);
        }
      });

      // Mouse-Hover: Bildvorschau
      if(getImageInfo(org.id)){
        el.addEventListener('mouseenter', (e) => {
          if(TAP_MODE) return;
          showHover(org.id, e.clientX, e.clientY);
        });
        el.addEventListener('mousemove', (e) => {
          if(TAP_MODE) return;
          if(!hoverTipEl.classList.contains('show')) return;
          positionHover(e.clientX, e.clientY);
        });
        el.addEventListener('mouseleave', () => {
          if(TAP_MODE) return;
          hideHover();
        });
      }

      return el;
    }

    function renderAll(){
      poolEl.innerHTML = '';
      Object.values(zoneBodies).forEach((el) => { if(el !== poolEl) el.innerHTML = ''; });

      for(const org of ORGANISMS){
        const z = state.placement.get(org.id) || 'pool';
        const card = createCardEl(org);

        if(state.marksOn){
          const placed = state.placement.get(org.id) || 'pool';
          if(placed === org.correct) card.classList.add('correct');
          else if(placed !== 'pool') card.classList.add('wrong');
        }

        zoneBodies[z].appendChild(card);
      }

      updateCounts();

      // Status im Tablet-Modus, wenn nicht geprüft
      if(TAP_MODE && !state.marksOn){
        if(state.selectedCardId){
          const org = ORGANISMS.find(o => o.id === state.selectedCardId);
          setStatus(`Ausgewählt: ${org?.name ?? ''} – Ziel-Feld antippen.`, 'warn');
        } else {
          setStatus('Punkte: –');
        }
      }

      // Wenn geprüft, Score aktuell halten
      if(state.marksOn) updateScore();
    }

    function moveCard(cardId, zoneId){
      if(zoneId === 'pool') state.placement.delete(cardId);
      else state.placement.set(cardId, zoneId);

      if(state.selectedCardId === cardId) state.selectedCardId = null;

      // Markierungen NICHT löschen: nach „Prüfen“ sollen Korrekturen möglich sein.
      renderAll();
    }

    // ======= Drop targets (Desktop DnD) =======
    function wireDropTarget(targetEl, zoneId){
      targetEl.addEventListener('dragover', (e) => {
        if(TAP_MODE) return;
        e.preventDefault();
        targetEl.classList.add('dragOver');
        if(e.dataTransfer) e.dataTransfer.dropEffect = 'move';
      });
      targetEl.addEventListener('dragleave', () => targetEl.classList.remove('dragOver'));
      targetEl.addEventListener('drop', (e) => {
        if(TAP_MODE) return;
        e.preventDefault();
        targetEl.classList.remove('dragOver');
        const cardId = e.dataTransfer?.getData('text/plain');
        if(!cardId) return;
        moveCard(cardId, zoneId);
      });
    }

    document.querySelectorAll('.zone').forEach(zone => wireDropTarget(zone, zone.dataset.zone));
    wireDropTarget(poolEl, 'pool');

    // ======= Tap-to-Move targets (Tablet) =======
    function wireTapTarget(el, zoneId){
      el.addEventListener('pointerdown', (e) => {
        if(!TAP_MODE) return;
        if(e.pointerType !== 'touch' && e.pointerType !== 'pen') return;
        if(!state.selectedCardId) return;
        e.preventDefault();
        moveCard(state.selectedCardId, zoneId);
      }, { passive: false });
    }

    document.querySelectorAll('.zone').forEach(zone => wireTapTarget(zone, zone.dataset.zone));
    wireTapTarget(poolEl, 'pool');

    // Tap ins Leere hebt Auswahl auf (Tablet)
    document.addEventListener('pointerdown', (e) => {
      if(!TAP_MODE) return;
      if(e.pointerType !== 'touch' && e.pointerType !== 'pen') return;
      const t = e.target;
      if(t.closest && (t.closest('.card') || t.closest('.zone') || t.closest('#pool') || t.closest('button'))) return;
      state.selectedCardId = null;
      renderAll();
    }, { passive: true });

    // ======= Hilfe (Definitionen; an den Drop-Zonen) =======
    const HELP = {
      producer: {
        title: 'Produzenten',
        html: `
          <h3 style="margin:0 0 10px; font-size:16px;">Produzenten</h3>
          <div style="font-size:13px; line-height:1.55; color:rgba(231,238,252,.92);">
            <p style="margin:0 0 10px;"><b>Produzenten</b> stellen (z.B. durch Fotosynthese) aus anorganischen Stoffen energiereiche organische Stoffe her.</p>
            <p style="margin:0;"><b>Beispiele im See:</b> Wasserpflanzen, Algen (Phytoplankton).</p>
          </div>
        `
      },
      c1: {
        title: 'Konsumenten 1. Ordnung',
        html: `
          <h3 style="margin:0 0 10px; font-size:16px;">Konsumenten 1. Ordnung</h3>
          <div style="font-size:13px; line-height:1.55; color:rgba(231,238,252,.92);">
            <p style="margin:0 0 10px;"><b>Konsumenten 1. Ordnung</b> (Primärkonsumenten) ernähren sich von Produzenten oder deren Teilen.</p>
            <p style="margin:0;"><b>Beispiele:</b> Wasserflöhe, Schnecken (vereinfachte Darstellung).</p>
          </div>
        `
      },
      c2: {
        title: 'Konsumenten 2. Ordnung',
        html: `
          <h3 style="margin:0 0 10px; font-size:16px;">Konsumenten 2. Ordnung</h3>
          <div style="font-size:13px; line-height:1.55; color:rgba(231,238,252,.92);">
            <p style="margin:0 0 10px;"><b>Konsumenten 2. Ordnung</b> (Sekundärkonsumenten) fressen Konsumenten 1. Ordnung.</p>
            <p style="margin:0;"><b>Beispiele:</b> räuberische Insektenlarven, kleine Raubfische.</p>
          </div>
        `
      },
      c3: {
        title: 'Konsumenten 3. Ordnung',
        html: `
          <h3 style="margin:0 0 10px; font-size:16px;">Konsumenten 3. Ordnung</h3>
          <div style="font-size:13px; line-height:1.55; color:rgba(231,238,252,.92);">
            <p style="margin:0 0 10px;"><b>Konsumenten 3. Ordnung</b> (Tertiärkonsumenten) fressen Konsumenten 2. Ordnung und stehen in dieser Vereinfachung häufig weit oben.</p>
            <p style="margin:0;"><b>Beispiele:</b> Hecht, Graureiher, Fischotter.</p>
          </div>
        `
      }
    };

    function ensureHelpModal(){
      let modal = document.getElementById('helpModal');
      if(modal) return modal;

      modal = document.createElement('div');
      modal.id = 'helpModal';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.zIndex = '10080';
      modal.style.display = 'none';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.padding = '18px';
      modal.style.background = 'rgba(0,0,0,.55)';
      modal.setAttribute('role','dialog');
      modal.setAttribute('aria-modal','true');

      const card = document.createElement('div');
      card.style.maxWidth = '760px';
      card.style.width = '100%';
      card.style.borderRadius = '18px';
      card.style.border = '1px solid rgba(255,255,255,.16)';
      card.style.background = 'rgba(17,26,44,.92)';
      card.style.boxShadow = '0 18px 50px rgba(0,0,0,.6)';
      card.style.backdropFilter = 'blur(8px)';
      card.style.overflow = 'hidden';

      const head = document.createElement('div');
      head.style.display = 'flex';
      head.style.alignItems = 'center';
      head.style.justifyContent = 'space-between';
      head.style.gap = '10px';
      head.style.padding = '12px 14px';
      head.style.borderBottom = '1px solid rgba(255,255,255,.12)';

      const title = document.createElement('div');
      title.id = 'helpModalTitle';
      title.style.fontWeight = '750';
      title.style.letterSpacing = '.2px';
      title.textContent = 'Hilfe';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'bad';
      closeBtn.textContent = 'Schließen';
      closeBtn.addEventListener('click', () => hideHelp());

      head.appendChild(title);
      head.appendChild(closeBtn);

      const body = document.createElement('div');
      body.id = 'helpModalBody';
      body.style.padding = '14px';
      body.innerHTML = '';

      card.appendChild(head);
      card.appendChild(body);
      modal.appendChild(card);

      modal.addEventListener('pointerdown', (e) => {
        if(e.target === modal) hideHelp();
      });

      document.body.appendChild(modal);
      return modal;
    }

    function showHelp(topic){
      const modal = ensureHelpModal();
      const t = HELP[topic] ? topic : 'producer';
      const titleEl = document.getElementById('helpModalTitle');
      const bodyEl = document.getElementById('helpModalBody');
      if(titleEl) titleEl.textContent = HELP[t].title;
      if(bodyEl) bodyEl.innerHTML = HELP[t].html;
      modal.style.display = 'flex';
    }

    function hideHelp(){
      const modal = document.getElementById('helpModal');
      if(modal) modal.style.display = 'none';
    }

    // Info-Buttons in den Drop-Zonen
    document.querySelectorAll('.infoBtn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showHelp(btn.dataset.help);
      });
    });

    // ESC schließt Hilfe
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') hideHelp();
    });

    // ======= Buttons =======
    btnReset.addEventListener('click', () => {
      shuffle(ORGANISMS);
      state.placement.clear();
      state.selectedCardId = null;
      clearMarks();
      renderAll();
    });

    btnCheck.addEventListener('click', () => {
      state.marksOn = true;
      updateScore();
      renderAll();
    });

    // ======= Mini-Selbsttests (Konsole) =======
    function runSelfTests(){
      console.assert(!!poolEl, 'poolEl fehlt');
      console.assert(!!btnReset && !!btnCheck, 'Buttons fehlen');
      console.assert(ORGANISMS.length > 0, 'Keine Organismen definiert');
      const cards = document.querySelectorAll('.card');
      console.assert(cards.length === ORGANISMS.length, 'Anzahl Karten stimmt nicht');
    }

    // ======= Init =======
    (function init(){
      shuffle(ORGANISMS);
      state.placement.clear();
      state.selectedCardId = null;
      clearMarks();
      updateCounts();
      renderAll();
      runSelfTests();

      // ESC schließt Hover (Desktop)
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') hideHover();
      });
    })();
  </script>
</body>
</html>
